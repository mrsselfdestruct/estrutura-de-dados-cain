<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>CRUD Node.js + Express (Editar)</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; }
    ul { list-style: none; padding-left: 0; }
    li { margin: 8px 0; }
    .actions button { margin-left: 8px; }
    .edit-row input { width: 140px; margin-right: 8px; }
  </style>
</head>
<body>
  <h1>Lista de Produtos</h1>
 
  <!-- Formulário para criar produto -->
  <form id="form">
    <input type="text" name="name" placeholder="Nome" required />
    <input type="number" step="0.01" name="price" placeholder="Preço" required />
    <button type="submit">Adicionar</button>
  </form>
 
  <ul id="list"></ul>
 
  <script>
    // URL da API (backend) - rode o Node em http://localhost:3000
    const API_URL = "http://localhost:3000/api/products";
 
    const form = document.getElementById("form");
    const list = document.getElementById("list");
 
    // Guardamos os produtos carregados para facilitar a edição
    let productsCache = [];
 
    // Carregar lista de produtos
    async function loadProducts() {
      const res = await fetch(API_URL);
      const data = await res.json();
      productsCache = data; // atualiza cache
      renderList(data);
    }
 
    function renderList(items) {
      list.innerHTML = "";
      items.forEach(p => {
        const li = document.createElement("li");
        li.id = "item-" + p.id;
        li.innerHTML = `
          <span><strong>#${p.id}</strong> - ${escapeHtml(p.name)} - R$ ${Number(p.price).toFixed(2)}</span>
          <span class="actions">
            <button onclick="startEdit(${p.id})">Editar</button>
            <button onclick="deleteProduct(${p.id})">Excluir</button>
          </span>
        `;
        list.appendChild(li);
      });
    }
 
    // Evitar injeção quando renderizamos texto dinâmico
    function escapeHtml(str) {
      return String(str).replace(/[&<>'\"]/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", "'":"&#39;", '"':"&quot;"
      }[s]));
    }
 
    // Criar novo produto
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      form.reset();
      loadProducts();
    });
 
    // Deletar produto
    async function deleteProduct(id) {
      await fetch(`${API_URL}/${id}`, { method: "DELETE" });
      loadProducts();
    }
 
    // Inicia modo de edição inline
    function startEdit(id) {
      const p = productsCache.find(x => x.id === id);
      if (!p) return;
 
      const li = document.getElementById("item-" + id);
      li.innerHTML = `
        <div class="edit-row">
          <label>Nome: <input id="edit-name-${id}" value="${escapeHtml(p.name)}" /></label>
          <label>Preço: <input id="edit-price-${id}" type="number" step="0.01" value="${Number(p.price)}" /></label>
          <button onclick="saveEdit(${id})">Salvar</button>
          <button onclick="cancelEdit(${id})">Cancelar</button>
        </div>
      `;
    }
 
    // Salva a edição via PUT
    async function saveEdit(id) {
      const nameEl = document.getElementById("edit-name-" + id);
      const priceEl = document.getElementById("edit-price-" + id);
      const payload = {
        name: nameEl.value,
        price: priceEl.value
      };
 
      const res = await fetch(`${API_URL}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
 
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Erro ao editar" }));
        alert(err.error || "Erro ao editar");
        return;
      }
 
      // Recarrega a lista para refletir alterações
      loadProducts();
    }
 
    // Cancela a edição e volta a renderização normal
    function cancelEdit(id) {
      renderList(productsCache);
    }
 
    // Carrega ao iniciar
    loadProducts();
  </script>
</body>
</html>
